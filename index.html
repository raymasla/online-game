<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firebase éŠæˆ²å¤§å»³ï¼šå®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <style>
        /* --- é€šç”¨æ¨£å¼ --- */
        body { font-family: 'PingFang TC', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; touch-action: manipulation; transition: background 0.5s; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; margin-bottom: 20px; position: relative; z-index: 10; }
        .hidden { display: none !important; }
        
        /* æŒ‰éˆ•èˆ‡åˆ—è¡¨ */
        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; cursor: pointer; border: none; border-radius: 8px; background: #007bff; color: white; transition: 0.2s; }
        .menu-btn:hover { background: #0056b3; }
        .btn-c4 { background: #2c3e50; } 
        
        /* å°æŒ‰éˆ•æ¨£å¼ */
        .btn-sm { border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 5px; color: white; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-undo { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; }

        /* æˆ¿é–“åˆ—è¡¨é …ç›® */
        .room-item { border: 1px solid #ddd; padding: 12px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; background: #fafafa; }
        .room-info { text-align: left; display: flex; flex-direction: column; }
        .room-name { font-weight: bold; font-size: 1.1em; }
        
        /* è¼¸å…¥æ¡† */
        input { padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { margin: 10px 0; text-align: left; }
        .input-group label { display: inline-block; width: 100px; font-weight: bold;}
        .input-group input { width: calc(100% - 120px); box-sizing: border-box;}

        /* --- éŠæˆ²å€å¡Š --- */
        #status { font-weight: bold; color: #d9534f; margin: 10px 0; min-height: 24px; }

        /* --- èŠå¤©å®¤ --- */
        #chat-area { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; text-align: left; }
        #chat-msgs { height: 120px; overflow-y: auto; background: #f8f9fa; border-radius: 4px; padding: 5px; font-size: 0.85em; margin-bottom: 5px; border: 1px solid #ddd; }
        .chat-input-group { display: flex; gap: 5px; }
        .chat-input-group input { flex: 1; text-align: left; font-size: 0.9em; }
        
        /* æš±ç¨±ç·¨è¼¯æ¨£å¼ */
        .editable-name { color: #007bff; font-weight: bold; cursor: pointer; border-bottom: 1px dashed #007bff; }
        .editable-name:hover { color: #0056b3; border-bottom-style: solid; }

        /* --- å››é€£æ£‹æ¨£å¼ --- */
        :root { --c4-cell-size: clamp(35px, 9vw, 50px); }
        #c4-game-wrapper { display: flex; flex-direction: column; align-items: center; background-color: rgba(44, 62, 80, 0.9); padding: 15px; border-radius: 10px; transition: 0.5s; }
        .c4-board { display: grid; grid-template-columns: repeat(7, var(--c4-cell-size)); grid-template-rows: repeat(6, var(--c4-cell-size)); gap: 5px; padding: 10px; background: #3498db; border-radius: 10px; }
        .c4-cell { width: var(--c4-cell-size); height: var(--c4-cell-size); background-color: #1a252f; border-radius: 50%; position: relative; }
        .piece { width: 100%; height: 100%; border-radius: 50%; animation: dropAnim 0.5s forwards; }
        .p1 { background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000); }
        .p2 { background: radial-gradient(circle at 30% 30%, #ffd93d, #d4a017); }
        @keyframes dropAnim { from { transform: translateY(-200px); } to { transform: translateY(0); } }

        /* --- åœˆåœˆå‰å‰ --- */
        #ttt-board { display: grid; gap: 5px; margin: 10px auto; background: #ccc; padding: 5px; border-radius: 5px; }
        .ttt-cell { background: white; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; cursor: pointer;}

        /* --- å‹åˆ©ç‰¹æ•ˆ & å·¨å¤§æŒ‰éˆ• --- */
        #win-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; }
        .big-reset-btn { padding: 20px 40px; font-size: 24px; font-weight: bold; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(40, 167, 69, 0.6); transition: 0.3s; margin-top: 20px;}
        .big-reset-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div id="mainMenu" class="container">
    <h1>Firebase éŠæˆ²å¤§å»³</h1>
    <div id="allRoomsContainer">æœå°‹ä¸­...</div>
    <hr>
    <button class="menu-btn" onclick="showCreateRoom('ttt')">å‰µç«‹ åœˆåœˆå‰å‰</button>
    <button class="menu-btn btn-c4" onclick="showCreateRoom('c4')">å‰µç«‹ å››é€£æ£‹</button>
</div>

<div id="createRoomSection" class="container hidden">
    <h3 id="createTitle">å‰µç«‹æˆ¿é–“</h3>
    <div class="input-group"><label>æˆ¿é–“åç¨±:</label><input type="text" id="roomName" placeholder="æœªå‘½åæˆ¿é–“"></div>
    <div class="input-group"><label>è¨­å®šå¯†ç¢¼:</label><input type="password" id="roomPass" placeholder="å¯ç•™ç©º"></div>
    <button class="menu-btn" onclick="createRoom()">ç¢ºèªå‰µç«‹</button>
    <button onclick="showSection('mainMenu')">è¿”å›</button>
</div>

<div id="gameArea" class="container hidden">
    <h3 id="roomDisplayInfo"></h3>
    <div id="status">è¼‰å…¥ä¸­...</div>

    <div id="ttt-board" class="hidden"></div>
    <div id="c4-game-wrapper" class="hidden">
        <div id="c4-board" class="c4-board"></div>
    </div>

    <button class="btn-undo" onclick="undoStep()">â¬… æ‚”æ£‹ (å›ä¸Šä¸€æ­¥)</button>

    <div id="chat-area">
        <div style="margin-bottom: 5px; font-size: 0.9em; color: #555;">
            æˆ‘æ˜¯: <span id="myNameDisplay" class="editable-name" onclick="editName()">ç©å®¶</span> âœ
        </div>
        
        <div id="chat-msgs"></div>
        <div class="chat-input-group">
            <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">å‚³é€</button>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button onclick="resetGame()">é‡æ–°é–‹å§‹</button>
        <button onclick="leaveRoom()">é›¢é–‹æˆ¿é–“</button>
    </div>
</div>

<div id="win-overlay">
    <h1 id="win-message">å‹åˆ©ï¼</h1>
    <button class="big-reset-btn" onclick="resetGame()">ğŸ”„ é‡æ–°é–‹å§‹ ğŸ”„</button>
    <button style="margin-top:15px; background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:20px;" onclick="closeWinOverlay()">æš«æ™‚é—œé–‰</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
        authDomain: "onlineeasyraygame.firebaseapp.com",
        databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "onlineeasyraygame"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentRoomId = null, selectedGameType = 'ttt', roomDataCache = null;
    
    // é è¨­ç©å®¶åç¨± (éš¨æ©Ÿç”¢ç”Ÿä¸€é»è®ŠåŒ–)
    let myName = "ç©å®¶" + Math.floor(Math.random() * 100);

    // --- åˆå§‹åŒ–ï¼šé¡¯ç¤ºæ‰€æœ‰æˆ¿é–“ (åŒ…å«åˆªé™¤æŒ‰éˆ•) ---
    function initLobby() {
        onValue(ref(db, 'rooms'), (snapshot) => {
            const container = document.getElementById('allRoomsContainer');
            container.innerHTML = "";
            const rooms = snapshot.val();
            if (!rooms) { container.innerHTML = "<p>ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œä¾†é–‹ä¸€å€‹å§ï¼</p>"; return; }
            
            Object.entries(rooms).reverse().forEach(([id, r]) => {
                const userCount = r.users ? Object.keys(r.users).length : 0;
                const typeName = r.type === 'c4' ? 'ğŸ”µå››é€£æ£‹' : 'âŒåœˆåœˆå‰å‰';
                
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <div class="room-info">
                        <span class="room-name">${typeName} | ${r.name}</span>
                        <span style="font-size:0.8em; color:#666">äººæ•¸: ${userCount}</span>
                    </div>
                    <div>
                        <button class="btn-sm btn-green" onclick="enterRoom('${id}')">åŠ å…¥</button>
                        <button class="btn-sm btn-red" onclick="deleteRoom('${id}')">åˆªé™¤</button>
                    </div>`;
                container.appendChild(div);
            });
        });
    }
    initLobby();

    // --- åˆªé™¤æˆ¿é–“åŠŸèƒ½ ---
    window.deleteRoom = (id) => {
        if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å€‹æˆ¿é–“å—ï¼Ÿ")) {
            remove(ref(db, 'rooms/' + id)).then(() => alert("æˆ¿é–“å·²åˆªé™¤"));
        }
    };

    // --- æˆ¿é–“ç®¡ç† ---
    window.showCreateRoom = (type) => {
        selectedGameType = type;
        document.getElementById('createTitle').innerText = `å‰µç«‹ ${type==='c4'?'å››é€£æ£‹':'åœˆåœˆå‰å‰'}`;
        showSection('createRoomSection');
    };

    window.createRoom = () => {
        const name = document.getElementById('roomName').value || "å¥½ç©æˆ¿é–“";
        const pass = document.getElementById('roomPass').value;
        // å‰µæˆ¿æ™‚ä¸å¼·åˆ¶æ”¹åï¼Œç›´æ¥ç”¨ç›®å‰çš„ myName
        
        const roomRef = push(ref(db, 'rooms'));
        const initBoard = selectedGameType === 'c4' ? Array(42).fill(0) : Array(9).fill("");
        
        set(roomRef, {
            type: selectedGameType, name, password: pass,
            board: initBoard, turn: 0, history: [initBoard]
        }).then(() => enterRoom(roomRef.key));
    };

    window.enterRoom = (id) => {
        currentRoomId = id;
        showSection('gameArea');
        document.getElementById('myNameDisplay').innerText = myName; // é¡¯ç¤ºç›®å‰åç¨±

        const userRef = push(ref(db, `rooms/${id}/users`));
        onDisconnect(userRef).remove();
        set(userRef, { name: myName });

        // ç›£è½æˆ¿é–“ç‹€æ…‹
        onValue(ref(db, 'rooms/' + id), (snapshot) => {
            const data = snapshot.val();
            if (!data) { alert("æˆ¿é–“å·²è¢«åˆªé™¤"); leaveRoom(); return; }
            roomDataCache = data;
            renderGame(data);
            checkWinner(data);
        });

        // ç›£è½èŠå¤©å®¤
        onValue(ref(db, `rooms/${id}/chat`), (snapshot) => {
            const chatDiv = document.getElementById('chat-msgs');
            chatDiv.innerHTML = "";
            const msgs = snapshot.val();
            if(msgs) {
                Object.values(msgs).forEach(m => {
                    const p = document.createElement('div');
                    p.innerHTML = `<b>${m.user}:</b> ${m.text}`;
                    chatDiv.appendChild(p);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        });
    };

    // --- æš±ç¨±ç·¨è¼¯åŠŸèƒ½ ---
    window.editName = () => {
        const newName = prompt("è«‹è¼¸å…¥æ‚¨çš„æ–°æš±ç¨±:", myName);
        if (newName && newName.trim() !== "") {
            myName = newName.trim();
            document.getElementById('myNameDisplay').innerText = myName;
            // é€™è£¡å¯ä»¥é¸æ“‡æ›´æ–° Firebase çš„ users åˆ—è¡¨ï¼Œä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘ä¸»è¦æ›´æ–°èŠå¤©ç™¼é€çš„åç¨±
        }
    };

    // --- éŠæˆ²é‚è¼¯ ---
    function renderGame(data) {
        document.getElementById('roomDisplayInfo').innerText = data.name;
        if (data.type === 'c4') {
            document.getElementById('ttt-board').classList.add('hidden');
            document.getElementById('c4-game-wrapper').classList.remove('hidden');
            const boardDiv = document.getElementById('c4-board');
            boardDiv.innerHTML = "";
            data.board.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'c4-cell';
                if(val > 0) cell.innerHTML = `<div class="piece p${val}"></div>`;
                cell.onclick = () => dropC4(i % 7);
                boardDiv.appendChild(cell);
            });
            document.getElementById('status').innerText = `è¼ªåˆ°ç©å®¶: ${data.turn % 2 + 1}`;
        } else {
            document.getElementById('c4-game-wrapper').classList.add('hidden');
            document.getElementById('ttt-board').classList.remove('hidden');
            const boardDiv = document.getElementById('ttt-board');
            boardDiv.style.gridTemplateColumns = "repeat(3, 1fr)";
            boardDiv.innerHTML = "";
            data.board.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'ttt-cell';
                cell.innerText = val;
                cell.onclick = () => clickTTT(i);
                boardDiv.appendChild(cell);
            });
            document.getElementById('status').innerText = `è¼ªåˆ°: ${data.turn % 2 === 0 ? 'X' : 'O'}`;
        }
    }

    function dropC4(col) {
        const board = [...roomDataCache.board];
        for (let r = 5; r >= 0; r--) {
            if (board[r * 7 + col] === 0) {
                board[r * 7 + col] = (roomDataCache.turn % 2) + 1;
                updateMove(board);
                break;
            }
        }
    }

    function clickTTT(i) {
        if (roomDataCache.board[i] !== "") return;
        const board = [...roomDataCache.board];
        board[i] = roomDataCache.turn % 2 === 0 ? "X" : "O";
        updateMove(board);
    }

    function updateMove(newBoard) {
        const history = roomDataCache.history || [];
        history.push(newBoard);
        update(ref(db, `rooms/${currentRoomId}`), {
            board: newBoard,
            turn: roomDataCache.turn + 1,
            history: history
        });
    }

    window.undoStep = () => {
        const history = roomDataCache.history || [];
        if (history.length <= 1) return alert("ä¸èƒ½å†é€€äº†ï¼");
        history.pop();
        const lastBoard = history[history.length - 1];
        update(ref(db, `rooms/${currentRoomId}`), {
            board: lastBoard,
            turn: roomDataCache.turn - 1,
            history: history
        });
    };

    // --- èŠå¤©å®¤åŠŸèƒ½ ---
    window.sendMessage = () => {
        const input = document.getElementById('chatInput');
        if (!input.value.trim()) return;
        push(ref(db, `rooms/${currentRoomId}/chat`), {
            user: myName, // ä½¿ç”¨ç•¶å‰è¨­å®šçš„åç¨±
            text: input.value,
            time: serverTimestamp()
        });
        input.value = "";
    };

    // --- å‹åˆ©æª¢æ¸¬èˆ‡ UI ---
    function checkWinner(data) {
        const winner = data.type === 'c4' ? checkWinC4(data.board) : checkWinTTT(data.board);
        if (winner) {
            document.getElementById('win-message').innerText = `ğŸ‰ æ­å–œç©å®¶ ${winner} ç²å‹ï¼ ğŸ‰`;
            document.getElementById('win-overlay').style.display = 'flex';
        } else {
            document.getElementById('win-overlay').style.display = 'none';
        }
    }

    window.resetGame = () => {
        const initBoard = roomDataCache.type === 'c4' ? Array(42).fill(0) : Array(9).fill("");
        set(ref(db, `rooms/${currentRoomId}/history`), [initBoard]);
        update(ref(db, `rooms/${currentRoomId}`), { board: initBoard, turn: 0 });
        closeWinOverlay();
    };

    window.closeWinOverlay = () => document.getElementById('win-overlay').style.display = 'none';
    window.showSection = (id) => {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };
    window.leaveRoom = () => location.reload();

    // å‹è² é‚è¼¯
    function checkWinTTT(b) {
        const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let l of lines) if(b[l[0]] && b[l[0]]===b[l[1]] && b[l[0]]===b[l[2]]) return b[l[0]];
        return null;
    }
    function checkWinC4(b) {
        const get = (r,c) => (r<0||r>=6||c<0||c>=7) ? 0 : b[r*7+c];
        for(let r=0; r<6; r++) {
            for(let c=0; c<7; c++) {
                let p = get(r,c); if(!p) continue;
                if(get(r,c+1)===p && get(r,c+2)===p && get(r,c+3)===p) return p;
                if(get(r+1,c)===p && get(r+2,c)===p && get(r+3,c)===p) return p;
                if(get(r+1,c+1)===p && get(r+2,c+2)===p && get(r+3,c+3)===p) return p;
                if(get(r+1,c-1)===p && get(r+2,c-2)===p && get(r+3,c-3)===p) return p;
            }
        }
        return null;
    }
</script>
</body>
</html>
