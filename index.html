<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase å¤šåŠŸèƒ½é€£ç·šæ£‹ç›¤ (åŠ å¼·ç‰ˆ)</title>
    <style>
        body { font-family: 'PingFang TC', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        .hidden { display: none; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; cursor: pointer; border: none; border-radius: 8px; background: #007bff; color: white; transition: 0.2s; }
        .menu-btn:hover { background: #0056b3; }
        .btn-red { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;}
        .btn-green { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .room-item { border: 1px solid #ddd; padding: 12px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; background: #fafafa; }
        .room-info { text-align: left; display: flex; flex-direction: column; }
        .room-name { font-weight: bold; font-size: 1.1em; }
        .room-meta { font-size: 0.85em; color: #666; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input { padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { margin: 10px 0; text-align: left; }
        .input-group label { display: inline-block; width: 100px; font-weight: bold;}
        .input-group input { width: calc(100% - 120px); box-sizing: border-box;}

        /* å‹•æ…‹æ£‹ç›¤ */
        #gameBoard { display: grid; gap: 5px; margin: 20px auto; background: #ccc; padding: 5px; border-radius: 5px; }
        .cell { background: white; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .cell:hover { background: #f0f0f0; }
        #status { font-weight: bold; color: #d9534f; margin: 10px 0; }
    </style>
</head>
<body>

<div id="mainMenu" class="container">
    <h1>éŠæˆ²å¤§å»³</h1>
    <button class="menu-btn" onclick="showSection('gameModeSelect')">åœˆåœˆå‰å‰</button>
    <button class="menu-btn" style="background:#6c757d">å››é€£æ£‹ (é–‹ç™¼ä¸­)</button>
</div>

<div id="gameModeSelect" class="container hidden">
    <h2>åœˆåœˆå‰å‰</h2>
    <button class="menu-btn" onclick="showSection('createRoomSection')">å‰µç«‹æ–°æˆ¿é–“</button>
    <button class="menu-btn" onclick="listRooms()">åŠ å…¥ç¾æœ‰æˆ¿é–“</button>
    <button onclick="showSection('mainMenu')">å›ä¸»é¸å–®</button>
</div>

<div id="createRoomSection" class="container hidden">
    <h3>å‰µç«‹æˆ¿é–“è¨­å®š</h3>
    
    <div class="input-group">
        <label>æˆ¿é–“åç¨±:</label>
        <input type="text" id="roomName" placeholder="æœªå‘½åæˆ¿é–“">
    </div>
    <div class="input-group">
        <label>è¨­å®šå¯†ç¢¼:</label>
        <input type="password" id="roomPass" placeholder="ç•™ç©ºå‰‡å…¬é–‹">
    </div>
    <hr>
    <div class="input-group">
        <label>æ£‹ç›¤å¤§å° (N):</label>
        <input type="number" id="boardN" value="3" min="3" max="10">
    </div>
    <div class="input-group">
        <label>é€£ç·šç›®æ¨™ (K):</label>
        <input type="number" id="goalK" value="3" min="3">
    </div>
    <div class="input-group">
        <label>äººæ•¸ (1-8):</label>
        <input type="number" id="maxP" value="2" min="1" max="8">
    </div>

    <button class="menu-btn" onclick="createRoom()">ç¢ºèªå‰µç«‹ä¸¦é€²å…¥</button>
    <button onclick="showSection('gameModeSelect')">è¿”å›</button>
</div>

<div id="roomListSection" class="container hidden">
    <h3>æˆ¿é–“åˆ—è¡¨</h3>
    <div id="roomsContainer">æ­£åœ¨æœå°‹æˆ¿é–“...</div>
    <button onclick="showSection('gameModeSelect')">è¿”å›</button>
</div>

<div id="gameArea" class="container hidden">
    <h3 id="roomDisplayInfo"></h3>
    <div id="status">è¼‰å…¥ä¸­...</div>
    <div id="gameBoard"></div>
    <button onclick="resetGame()">é‡æ–°é–‹å§‹</button>
    <button onclick="location.reload()">é›¢é–‹æˆ¿é–“</button>
</div>

<script type="module">
    // åŠ å…¥ get å’Œ remove æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, get, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
        authDomain: "onlineeasyraygame.firebaseapp.com",
        databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "onlineeasyraygame",
        storageBucket: "onlineeasyraygame.firebasestorage.app",
        messagingSenderId: "622138442346",
        appId: "1:622138442346:web:375980b448fb9b3f428013"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentRoomId = null;

    // --- åˆ‡æ›ç•«é¢ ---
    window.showSection = (id) => {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- å‰µç«‹æˆ¿é–“ ---
    window.createRoom = () => {
        const nameInput = document.getElementById('roomName').value.trim();
        const passInput = document.getElementById('roomPass').value.trim();
        const n = parseInt(document.getElementById('boardN').value);
        const k = parseInt(document.getElementById('goalK').value);
        const max = parseInt(document.getElementById('maxP').value);
        
        // å¦‚æœæ²’å¡«åå­—ï¼Œçµ¦é è¨­å€¼
        const roomName = nameInput || `æˆ¿é–“ ${Math.floor(Math.random()*1000)}`;

        const roomRef = push(ref(db, 'rooms')); 
        const roomId = roomRef.key;

        set(roomRef, {
            name: roomName,
            password: passInput, // å„²å­˜å¯†ç¢¼ (æ³¨æ„ï¼šå‰ç«¯æ˜æ–‡å„²å­˜åƒ…ä¾›ç°¡æ˜“å¨›æ¨‚ä½¿ç”¨)
            n, k, max,
            board: Array(n*n).fill(""),
            turn: 0,
            symbols: ["O", "X", "â–³", "â–¡", "â˜…", "â—‡", "â—†", "â–²"]
        }).then(() => enterRoom(roomId));
    };

    // --- åˆ—å‡ºæˆ¿é–“ ---
    window.listRooms = () => {
        showSection('roomListSection');
        onValue(ref(db, 'rooms'), (snapshot) => {
            const container = document.getElementById('roomsContainer');
            container.innerHTML = "";
            const rooms = snapshot.val();
            
            if (!rooms) { container.innerHTML = "<p>ç›®å‰æ²’äººå‰µæˆ¿ï¼Œå¿«å»é–‹ä¸€é–“ï¼</p>"; return; }
            
            for (let id in rooms) {
                const r = rooms[id];
                const isLocked = r.password ? "ğŸ”’" : "ğŸ‘"; // é–é ­åœ–ç¤º
                
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <div class="room-info">
                        <span class="room-name">${r.name} ${isLocked}</span>
                        <span class="room-meta">${r.n}x${r.n} | ç›®æ¨™:${r.k} | ID:${id.substring(0,4)}</span>
                    </div>
                    <div>
                        <button class="btn-green" onclick="checkPasswordAndEnter('${id}')">é€²å…¥</button>
                        <button class="btn-red" onclick="deleteRoom('${id}')">åˆªé™¤</button>
                    </div>`;
                container.appendChild(div);
            }
        });
    };

    // --- æª¢æŸ¥å¯†ç¢¼é‚è¼¯ ---
    window.checkPasswordAndEnter = (id) => {
        // å…ˆè®€å–ä¸€æ¬¡è©²æˆ¿é–“è³‡æ–™ä¾†æª¢æŸ¥å¯†ç¢¼
        get(ref(db, 'rooms/' + id)).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.password && data.password !== "") {
                    // æœ‰å¯†ç¢¼ï¼Œè·³å‡ºè¼¸å…¥æ¡†
                    const inputPass = prompt(`æˆ¿é–“ã€Œ${data.name}ã€éœ€è¦å¯†ç¢¼ï¼š`);
                    if (inputPass === data.password) {
                        enterRoom(id);
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                    }
                } else {
                    // æ²’å¯†ç¢¼ï¼Œç›´æ¥é€²
                    enterRoom(id);
                }
            } else {
                alert("æˆ¿é–“å·²ä¸å­˜åœ¨");
            }
        });
    };

    // --- åˆªé™¤æˆ¿é–“ ---
    window.deleteRoom = (id) => {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æˆ¿é–“å—ï¼Ÿ")) {
            remove(ref(db, 'rooms/' + id))
                .then(() => alert("æˆ¿é–“å·²åˆªé™¤"))
                .catch((error) => alert("åˆªé™¤å¤±æ•—: " + error.message));
        }
    };

    // --- é€²å…¥æˆ¿é–“ä¸¦ç›£è½ ---
    window.enterRoom = (id) => {
        currentRoomId = id;
        showSection('gameArea');
        
        onValue(ref(db, 'rooms/' + id), (snapshot) => {
            const data = snapshot.val();
            // å¦‚æœæˆ¿é–“è¢«åˆªé™¤ï¼Œ data æœƒè®Šæˆ null
            if (!data) {
                alert("æˆ¿é–“å·²è¢«åˆªé™¤æˆ–ä¸å­˜åœ¨ï¼");
                showSection('roomListSection'); // å¼·åˆ¶è¸¢å›åˆ—è¡¨
                return;
            }

            document.getElementById('roomDisplayInfo').innerText = `${data.name} (ID: ${id.substring(0,4)})`;
            renderBoard(data);
        });
    };

    function renderBoard(data) {
        const boardDiv = document.getElementById('gameBoard');
        boardDiv.style.gridTemplateColumns = `repeat(${data.n}, 1fr)`;
        boardDiv.innerHTML = "";
        
        const currentSymbol = data.symbols[data.turn % data.max];
        document.getElementById('status').innerText = `è¼ªåˆ°ç©å®¶: ${currentSymbol}`;

        data.board.forEach((cell, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            div.innerText = cell;
            div.onclick = () => {
                if (data.board[i] !== "") return;
                const newBoard = [...data.board];
                newBoard[i] = currentSymbol;
                update(ref(db, 'rooms/' + currentRoomId), {
                    board: newBoard,
                    turn: data.turn + 1
                });
            };
            boardDiv.appendChild(div);
        });
    }

    window.resetGame = () => {
        onValue(ref(db, 'rooms/' + currentRoomId), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            update(ref(db, 'rooms/' + currentRoomId), {
                board: Array(data.n * data.n).fill(""),
                turn: 0
            });
        }, { onlyOnce: true });
    };

    // æŠŠé€™äº› function æ›è¼‰åˆ° window è®“ HTML onclick æ‰¾å¾—åˆ°
    window.checkPasswordAndEnter = checkPasswordAndEnter;
    window.deleteRoom = deleteRoom;

</script>
</body>
</html>
